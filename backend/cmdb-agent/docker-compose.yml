version: '3.8'

services:
  cmdb-agent:
    build: .
    container_name: cmdb-agent
    restart: unless-stopped
    environment:
      - AGENT_ID=agent-001
      - AGENT_NAME=primary-agent
      - AGENT_VERSION=1.0.0
      - AGENT_ENVIRONMENT=production
      - CMDB_API_URL=http://dharma-api-gateway:3000/api/cmdb
      - CMDB_API_KEY=${CMDB_API_KEY:-default-key}
      - CMDB_TENANT_ID=${CMDB_TENANT_ID:-default-tenant}
      - SCAN_INTERVAL_MINUTES=5
      - HEALTH_CHECK_INTERVAL_SECONDS=30
      - METRIC_COLLECTION_INTERVAL_SECONDS=60
      - AUTO_DISCOVERY_ENABLED=true
      - DISCOVER_DOCKER_CONTAINERS=true
      - CPU_THRESHOLD_PERCENT=80
      - MEMORY_THRESHOLD_PERCENT=85
      - DISK_THRESHOLD_PERCENT=90
      - AGENT_PORT=9000
      - LOG_LEVEL=info
      - DEFAULT_TAGS=monitored,auto-discovered
      - OWNER_TAG=DevOps Team
    ports:
      - "9000:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./logs:/app/logs
    networks:
      - iac_dharma-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:9000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  iac_dharma-network:
    external: true
