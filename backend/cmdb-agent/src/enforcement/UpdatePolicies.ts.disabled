/**
 * Update Enforcement Policies
 * 
 * Defines policies for managing agent updates
 */

import { SecurityPolicy } from './PolicyEngine';

/**
 * Get update-related enforcement policies
 */
export function getUpdatePolicies(): SecurityPolicy[] {
  return [
    {
      id: 'update-001',
      name: 'Mandatory Security Updates',
      description: 'Enforce installation of mandatory security updates',
      enabled: true,
      severity: 'critical',
      conditions: {
        updateType: 'security',
        mandatory: true,
      },
      actions: [
        {
          type: 'install-update',
          parameters: {
            force: true,
            timeout: 300000, // 5 minutes
          },
        },
        {
          type: 'log-event',
          parameters: {
            message: 'Mandatory security update enforced',
            level: 'info',
          },
        },
      ],
    },
    {
      id: 'update-002',
      name: 'Update Window Enforcement',
      description: 'Only allow updates during maintenance windows',
      enabled: true,
      severity: 'medium',
      conditions: {
        timeWindow: {
          start: '02:00',
          end: '04:00',
        },
      },
      actions: [
        {
          type: 'schedule-update',
          parameters: {
            nextWindow: true,
          },
        },
        {
          type: 'notify-user',
          parameters: {
            message: 'Update scheduled for next maintenance window',
          },
        },
      ],
    },
    {
      id: 'update-003',
      name: 'Rollback on Failure',
      description: 'Automatically rollback failed updates',
      enabled: true,
      severity: 'high',
      conditions: {
        updateStatus: 'failed',
      },
      actions: [
        {
          type: 'rollback-update',
          parameters: {
            restorePreviousVersion: true,
          },
        },
        {
          type: 'alert',
          parameters: {
            severity: 'high',
            message: 'Update failed, rolling back to previous version',
          },
        },
        {
          type: 'send-telemetry',
          parameters: {
            includeErrorLogs: true,
          },
        },
      ],
    },
    {
      id: 'update-004',
      name: 'Update Verification',
      description: 'Verify update integrity before installation',
      enabled: true,
      severity: 'critical',
      conditions: {
        updateStage: 'pre-install',
      },
      actions: [
        {
          type: 'verify-checksum',
          parameters: {
            algorithm: 'sha256',
            failOnMismatch: true,
          },
        },
        {
          type: 'verify-signature',
          parameters: {
            requireValidSignature: true,
          },
        },
      ],
    },
    {
      id: 'update-005',
      name: 'Update Notification',
      description: 'Notify administrators of update events',
      enabled: true,
      severity: 'low',
      conditions: {
        updateEvent: ['started', 'completed', 'failed'],
      },
      actions: [
        {
          type: 'send-notification',
          parameters: {
            channels: ['email', 'webhook'],
            includeDetails: true,
          },
        },
        {
          type: 'update-dashboard',
          parameters: {
            metric: 'update-status',
          },
        },
      ],
    },
    {
      id: 'update-006',
      name: 'Version Compliance',
      description: 'Ensure agent version meets minimum requirements',
      enabled: true,
      severity: 'high',
      conditions: {
        versionBelowMinimum: true,
      },
      actions: [
        {
          type: 'force-update',
          parameters: {
            targetVersion: 'latest',
            allowDowngrade: false,
          },
        },
        {
          type: 'restrict-functionality',
          parameters: {
            allowedOperations: ['update', 'health-check'],
          },
        },
      ],
    },
    {
      id: 'update-007',
      name: 'Staged Rollout',
      description: 'Deploy updates in stages based on agent groups',
      enabled: true,
      severity: 'medium',
      conditions: {
        agentGroup: ['canary', 'beta', 'production'],
      },
      actions: [
        {
          type: 'schedule-update',
          parameters: {
            delayBased: 'group',
            canaryDelay: 0,
            betaDelay: 86400000, // 24 hours
            productionDelay: 604800000, // 7 days
          },
        },
      ],
    },
    {
      id: 'update-008',
      name: 'Bandwidth Management',
      description: 'Control update download bandwidth',
      enabled: true,
      severity: 'low',
      conditions: {
        updateSize: '>50MB',
      },
      actions: [
        {
          type: 'throttle-download',
          parameters: {
            maxBandwidthMbps: 10,
            allowBusinessHoursOnly: true,
          },
        },
      ],
    },
    {
      id: 'update-009',
      name: 'Update Health Check',
      description: 'Verify agent health after update',
      enabled: true,
      severity: 'high',
      conditions: {
        updateStage: 'post-install',
      },
      actions: [
        {
          type: 'health-check',
          parameters: {
            timeout: 60000, // 1 minute
            requiredServices: ['monitoring', 'enforcement', 'telemetry'],
          },
        },
        {
          type: 'rollback-on-failure',
          parameters: {
            healthCheckFailed: true,
          },
        },
      ],
    },
    {
      id: 'update-010',
      name: 'Audit Logging',
      description: 'Comprehensive audit logging for all update activities',
      enabled: true,
      severity: 'medium',
      conditions: {
        updateEvent: '*',
      },
      actions: [
        {
          type: 'audit-log',
          parameters: {
            includeFields: [
              'timestamp',
              'agentId',
              'currentVersion',
              'targetVersion',
              'updateType',
              'initiator',
              'status',
              'duration',
            ],
            retention: 'permanent',
          },
        },
      ],
    },
  ];
}

export default getUpdatePolicies;
